<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="senaite.core">

  <metal:view_macro define-macro="view">
    <span metal:define-macro="textarea-field-view"
          tal:define="uid context/UID|nothing;
                      history python:field.get_history_records(context)"
          tal:condition="history"
          tal:attributes="id string:parent-fieldname-$fieldName-$uid"
          class="remarks_history">
      <span metal:define-slot="inside"
            tal:define="history accessor"
            tal:replace="structure history">textarea</span>
    </span>
  </metal:view_macro>

  <metal:remarks_edit define-macro="remarks_edit">
    <script type="text/javascript"
            tal:define="portal context/@@plone_portal_state/portal;"
            tal:attributes="src python:portal.absolute_url() + '/bika_widgets/remarkswidget.js'"></script>
    <textarea class="form-control"
              tal:attributes="name fieldName;
                              id fieldName;"></textarea>
    <div tal:condition="python: 'portal_factory' not in context.absolute_url()">
      <input class="saveRemarks allowMultiSubmit btn btn-secondary btn-sm input-sm"
             type="submit"
             value="Add remarks"
             i18n:attributes="value"
             i18n:domain="senaite.core"/>
    </div>
  </metal:remarks_edit>

  <metal:remarks_history define-macro="remarks_history">
    <style>
    #remarks-widget {
      margin: 20px 0 20px;
    }
    input.saveRemarks {
      margin: 10px 0 20px;
    }
    .remarks_history div.record {
      box-shadow: 1px 1px 4px #AAA;
      border-radius: 5px;
      margin: 10px 0 10px;
    }
    .remarks_history div.record-header {
      background-color: antiquewhite;
      padding:2px 10px;
      border-radius: 5px 5px 0 0;
      font-size: 0.8em;
      color: #666;
    }
    .record-date {
      float: right;
    }
    .remarks_history div.record .record-content {
      clear: both;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
    }
    </style>
    <div class="remarks_history">
      <tal:record repeat="record python:field.get_history(context)">
        <div class="record" tal:attributes="id record/id">
          <div class="record-header">
            <div class="record-date" tal:content="record/date"></div>
            <div class="record-user"
                 tal:define="user_name record/user_name;
                             user_fullname record/user_full_name;
                             user_name python: '{} ({})'.format(user_fullname, user_name).strip();"
                 tal:content="python:user_name"></div>
          </div>
          <div class="record-content"
               tal:content="structure python:field.to_html(record['content'])"></div>
        </div>
      </tal:record>
    </div>
  </metal:remarks_history>

  <metal:edit define-macro="edit">
    <metal:use use-macro="field_macro | context/widgets/field/macros/edit">
      <metal:fill fill-slot="widget_body">
        <metal:block use-macro="context/bika_widgets/remarkswidget/macros/remarks_history"/>
        <metal:block use-macro="context/bika_widgets/remarkswidget/macros/remarks_edit"/>
      </metal:fill>
    </metal:use>
  </metal:edit>

  <metal:search define-macro="search">
    <metal:use use-macro="context/widgets/field/macros/edit">
      <metal:fill fill-slot="widget_body">
        <metal:block use-macro="context/widgets/remarkswidget/macros/remarks_edit"/>
      </metal:fill>
    </metal:use>
  </metal:search>

</html>
