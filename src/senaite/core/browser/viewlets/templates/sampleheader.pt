<div id="senaite-sampleheader"
     tal:define="senaite_view python:context.restrictedTraverse('@@senaite_view');
                 test nocall:senaite_view/test;
                 errors python:request.get('errors', {});
                 fields python:view.get_header_fields();"
     i18n:domain="senaite.core">

  <div class="row">
    <div class="col-sm-12">

      <!-- SAMPLE HEADER FORM -->
      <tal:comment condition="python:False">
        <!--
             Note: the `novalidate` attribute is needed to avoid browser validation
             when e.g. the "expected sampling date" has passed and another value
             wants to be changed.

             https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Constraint_validation
        -->
      </tal:comment>
      <form id="senaite-sampleheader-form"
            name="sampleheader_form"
            class="senaite-form"
            method="post" novalidate>

        <!-- Hidden fields -->
        <input type="hidden" name="sampleheader_form_submitted" value="1" />

        <!-- Display Controls -->
        <div class="sampleheader-controls float-right">
          <!-- Toggle standard fields visibility -->
          <a href="#" class="text-decoration-none" data-toggle="collapse" data-target="#sampleheader-standard-fields">
            <span i18n:translate="" class="text-secondary">
              <i id="toggle-show-icon" class="fas fa-window-maximize"></i>
              <i id="toggle-hide-icon" class="fas fa-window-minimize d-none"></i>
            </span>
          </a>
        </div>

        <!-- Prominent fields -->
        <div id="sampleheader-prominent-fields" class="table-responsive collapse show">
          <table class="table table-sm table-bordered mb-1">
            <tr tal:repeat="group python:view.grouper(fields['prominent'], 1)">
              <tal:batch tal:repeat="fielddata python:group">
                <tal:fielddata tal:define="name     python:fielddata.get('name');
                                           mode     python:fielddata.get('mode');
                                           html     python:fielddata.get('html');
                                           field    python:fielddata.get('field');
                                           label    python:fielddata.get('label');
                                           required python:fielddata.get('required');">
                  <td class="bg-light"
                      style="min-width:200px;width:200px;">
                    <!-- Widget Label -->
                    <span tal:replace="label"/>
                    <!-- Display Required Marker -->
                    <span class="required"
                          tal:condition="python:required"
                          title="Required"
                          i18n:attributes="title title_required;"> </span>
                  </td>
                  <td>
                    <div class="form-row" tal:condition="python:html">
                      <div class="col-auto">
                        <!-- Render widget HTML -->
                        <div tal:content="structure html"/>
                      </div>
                    </div>
                    <div class="form-row" tal:condition="python:not html">
                      <div class="col-auto">
                        <!-- Render widget macro -->
                        <metal:field use-macro="python:view.render_widget(field, mode=mode)"/>
                      </div>
                    </div>
                  </td>
                </tal:fielddata>
              </tal:batch>
            </tr>
          </table>
      </div>

        <!-- Standard fields -->
        <div id="sampleheader-standard-fields" class="table-responsive collapse show">
          <table class="table table-sm table-bordered">
            <tr tal:repeat="group python:view.grouper(fields['visible'], 3)">
              <tal:batch tal:repeat="fielddata python:group">
                <tal:fielddata tal:define="name     python:fielddata.get('name');
                                           mode     python:fielddata.get('mode');
                                           html     python:fielddata.get('html');
                                           field    python:fielddata.get('field');
                                           label    python:fielddata.get('label');
                                           required python:fielddata.get('required');">
                  <td class="bg-light"
                      style="min-width:200px;width:200px;">
                    <!-- Widget Label -->
                    <span tal:replace="structure label"/>
                    <!-- Display Required Marker -->
                    <span class="required"
                          tal:condition="python:required"
                          title="Required"
                          i18n:attributes="title title_required;"> </span>
                  </td>
                  <td>
                    <div class="form-row" tal:condition="python:html">
                      <div class="col-auto">
                        <!-- Render widget HTML -->
                        <div tal:content="structure html"/>
                      </div>
                    </div>
                    <div class="form-row" tal:condition="python:not html">
                      <div class="col-auto">
                        <!-- Render widget macro -->
                        <metal:field use-macro="python:view.render_widget(field, mode=mode)"/>
                      </div>
                    </div>
                  </td>
                </tal:fielddata>
              </tal:batch>
            </tr>
          </table>
        </div>

        <!-- Save Button -->
        <input tal:condition="view/is_edit_allowed"
               class="btn btn-sm btn-primary mt-2"
               type="submit"
               name="form.button.save"
               value="Save"
               i18n:attributes="value label_save;"/>
      </form>


    </div>
  </div>

  <tal:js tal:define="portal context/@@plone_portal_state/portal;">
    <script type="text/javascript"
            tal:attributes="src python:portal.absolute_url() + '/senaite_widgets/referencewidget.js'"></script>
    <script type="text/javascript">
     document.addEventListener("DOMContentLoaded", function(event) {
       let show_icon = document.getElementById("toggle-show-icon");
       let hide_icon = document.getElementById("toggle-hide-icon");
       // Event handler when the standard fields are hidden
       $("#sampleheader-standard-fields").on("hide.bs.collapse", function () {
         console.log("Hide standard fields");
         $(show_icon).toggleClass("d-none", true);
         $(hide_icon).toggleClass("d-none", false)
       });
       // Event handler when the standard fields are shown
       $("#sampleheader-standard-fields").on("show.bs.collapse", function () {
         console.log("Show standard fields");
         $(show_icon).toggleClass("d-none", false);
         $(hide_icon).toggleClass("d-none", true)
       });

     });
    </script>
  </tal:js>
  <tal:css tal:define="portal context/@@plone_portal_state/portal;">
    <style type="text/css" media="screen">
     form[name="sampleheader_form"] select             { width: 220px!important; }
     form[name="sampleheader_form"] input[type="text"] { width: 220px!important; }
     form[name="sampleheader_form"] input[type="date"] { width: 130px!important; }
     form[name="sampleheader_form"] input[type="time"] { width: 90px!important; }
    </style>
  </tal:css>

</div>
